{{define "title"}}
VPN Connected Users (Peers)
{{end}}

{{define "top_css"}}
{{end}}

{{define "username"}}
{{ .username }}
{{end}}

{{define "page_title"}}
VPN Connected Users (Peers)
{{end}}

{{define "page_content"}}
<script>
  // Converts a number of bytes to a human-readable string.
  function bytesToHumanReadable(bytes) {
    const units = ["B", "KB", "MB", "GB", "TB", "PB", "EB", "ZB", "YB"];
    let i = 0;
    while (bytes >= 1024 && i < units.length - 1) {
      bytes /= 1024;
      i++;
    }
    return bytes.toFixed(2) + " " + units[i];
  }

  // Fetch and update the VPN status table.
  function updateStatusTable() {
    $.ajax({
      url: "{{.basePath}}/api/connection-status", // Make sure your APIStatus endpoint is registered.
      method: "GET",
      dataType: "json",
      success: function(data) {
        console.log("Received API status data:", data);
        // Use a fallback if devices is undefined.
        var devices = (data && data.devices && Array.isArray(data.devices)) ? data.devices : [];
        let html = "";
        devices.forEach(function(dev) {
          html += '<div class="table-responsive">';
          html += '<table class="table table-sm table-bordered table-striped">';
          html += '<caption>List of connected peers for device ' + dev.name + '</caption>';
          html += '<thead class="thead-dark"><tr>';
          html += '<th scope="col">#</th>';
          html += '<th scope="col">Name</th>';
          html += '<th scope="col">Email</th>';
          html += '<th scope="col">Allocated IPs</th>';
          html += '<th scope="col">Endpoint</th>';
          html += '<th scope="col">Public Key</th>';
          html += '<th scope="col">Received</th>';
          html += '<th scope="col">Transmitted</th>';
          html += '<th scope="col">Connected</th>';
          html += '<th scope="col">Last Handshake</th>';
          html += '</tr></thead>';
          html += '<tbody>';
          // Use the lowercase property names as provided by the API.
          dev.peers.forEach(function(peer, idx) {
            html += '<tr' + (peer.connected ? ' class="table-success"' : '') + '>';
            html += '<th scope="row">' + idx + '</th>';
            html += '<td>' + peer.name + '</td>';
            html += '<td>' + peer.email + '</td>';
            html += '<td>' + peer.allocated_ip + '</td>';
            html += '<td>' + peer.endpoint + '</td>';
            html += '<td>' + peer.public_key + '</td>';
            html += '<td title="' + peer.received_bytes + ' Bytes">' + bytesToHumanReadable(peer.received_bytes) + '</td>';
            html += '<td title="' + peer.transmit_bytes + ' Bytes">' + bytesToHumanReadable(peer.transmit_bytes) + '</td>';
            html += '<td>' + (peer.connected ? 'âœ“' : '') + '</td>';
            html += '<td>' + new Date(peer.last_handshake_time).toLocaleString() + '</td>';
            html += '</tr>';
          });
          html += '</tbody></table></div>';
        });
        $("#status-table-container").html(html);
      },
      error: function(err) {
        console.error("Error updating status:", err);
      }
    });
  }
</script>
<section class="content">
    <div class="container-fluid">
        {{ if .error }}
        <div class="alert alert-warning" role="alert">{{.error}}</div>
        {{ end }}
        <div id="status-table-container">
    </div>
</section>
{{end}}

{{define "bottom_js"}}
{{end}}
